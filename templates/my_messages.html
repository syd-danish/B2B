<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>My Messages - Elfit Arabia</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { background-color: #1a2b1f; padding: 130px; color: white; }
    .section { background-color: #2a3b2f; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .nav-link {white-space: nowrap; /margin-left: 15px; }
    .zoomable-image {
  transition: transform 0.2s ease;
}

.zoomable-image:hover {
  transform: scale(1.05);
}

.zoom-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 9999;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}

.zoom-overlay.active {
  display: flex;
}
.zoomed-image {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
  cursor: default;
  animation: zoomIn 0.3s ease;
}
.zoom-close {
  position: absolute;
  top: 20px;
  right: 30px;
  color: white;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
  user-select: none;
}
.zoom-close:hover {
  color: #ccc;
}
@keyframes zoomIn {
  from {
    transform: scale(0.5);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}


  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container-fluid">
      <a class="navbar-brand text-white" href="{{ url_for('dashboard') }}">Elfit Arabia Client Dashboard</a>
  </div>
  <div class="d-flex">
      <ul class="navbar-nav ms-auto">
         <li class="nav-item">
    <a class="nav-link text-white active" href="{{ url_for('my_messages') }}">My Messages
    {% if unread_count > 0 %}
          <span class="badge bg-danger rounded-pill ms-1">{{ unread_count }}</span>
      {% endif %}
    </a></li>
         <li class="nav-item">
      <a class="nav-link text-white" href="{{ url_for('my_orders') }}">My Orders</a></li>
             <li class="nav-item">
    <a class="nav-link text-white" href="{{ url_for('contact_us') }}">Contact Us</a></li>
         <li class="nav-item">
    <a class="nav-link text-white" href="{{ url_for('logout') }}">Logout</a>
         </li>
     </ul>
    </div>
  </div>
</nav>
<div class="container">
  <div class="section">
    <h2 style="padding-bottom: 20px"><strong>My Messages</strong></h2>
    {% if messages %}
      <div class="list-group">
        {% for msg in messages %}
        <div class="list-group-item mb-3" style="background:#3a5e46; color:white; padding-bottom: 20px ">
          <div class="d-flex justify-content-between">
              <h5><strong> {{ msg["subject"] }} </strong>: {{ msg["order_name"] }} ({{ msg["order_quantity"] }})</h5> <!-- subject -->
            <small>Ordered At: {{ msg["created_at"] }}</small> <!-- created_at -->
          </div>
          <p class="mb-1">{{ msg["body"] }}</p><!-- body -->
            {% if msg["attachment_name"] %}
<img src="{{ url_for('static', filename='uploads/products/' + msg['attachment_name']) }}"
     class="img-fluid mb-2 zoomable-image"
     style="max-height:150px; object-fit:contain; cursor: pointer;"
     onclick="toggleZoom(this)"
     alt="Order attachment">
{% endif %}
          <div class="mt-3 d-flex gap-2">
              {% if msg['order_status'] == "quote sent" %}
    <a href="{{ url_for('finalize_order', message_id=msg['id']) }}"
   class="btn btn-success btn-sm"
   onclick="
       if('{{ msg['order_status'] }}' == 'inquiry received' || '{{ msg['order_status'] }}' == 'quote sent') {
           return confirm('Are you sure you want to confirm this order?');
       } else {
           alert('Order has already been placed');
           return false;
       }
   ">
   Confirm Order
        {% endif %}
</a>
    <a href="{{ url_for('talk_further', message_id=msg[0]) }}" class="btn btn-primary btn-sm">Talk Further</a>

{% if msg['order_status'] == "order placed" %}
<!-- Cancel Order button -->
<button type="button" class="btn btn-danger btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#cancelOrderModal{{ msg['id'] }}">
    Cancel Order
</button>
              <div class="modal fade" id="cancelOrderModal{{ msg['id'] }}" tabindex="-1" aria-labelledby="cancelOrderLabel{{ msg['id'] }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background:#2a3b2f; color:white;">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelOrderLabel{{ msg['id'] }}">Confirm Cancellation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to cancel the order <strong>{{ msg['order_name'] }}</strong> ({{ msg['order_quantity'] }})?
      </div>
      <div class="modal-footer">
        <form method="POST" action="{{ url_for('cancel_order', message_id=msg['id']) }}">
          <button type="submit" class="btn btn-danger">Yes, Cancel Order</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Order</button>
      </div>
    </div>
  </div>
</div>

              {% endif %}

  </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No messages yet.</p>
    {% endif %}
  </div>
</div>

<div id="imageZoomOverlay" class="zoom-overlay" onclick="closeZoom()">
  <img id="zoomedImage" class="zoomed-image" onclick="event.stopPropagation()">
  <div class="zoom-close">&times;</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Add this script before closing </body> tag -->
<script>
function checkForNewMessages() {
    fetch('/api/unread-count')
        .then(response => response.json())
        .then(data => {
            const badge = document.querySelector('.badge-notification');
            const messagesLink = document.querySelector('a[href*="my_messages"]');

            if (data.count > 0) {
                if (badge) {
                    badge.textContent = data.count;
                } else {
                    // Create new badge if it doesn't exist
                    const newBadge = document.createElement('span');
                    newBadge.className = 'badge-notification';
                    newBadge.textContent = data.count;
                    messagesLink.appendChild(newBadge);
                }

                // Optional: Show browser notification
                if (Notification.permission === 'granted') {
                    new Notification('New Message', {
                        body: `You have ${data.count} unread message(s)`,
                        icon: '/static/favicon.ico' // Add your icon path
                    });
                }
            } else {
                // Remove badge if no unread messages
                if (badge) {
                    badge.remove();
                }
            }
        })
        .catch(error => console.error('Error checking messages:', error));
}

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();}
// Check for new messages every 30 seconds
setInterval(checkForNewMessages, 30000);
// Check immediately when page loads
document.addEventListener('DOMContentLoaded', checkForNewMessages);
function toggleZoom(img) {
  const overlay = document.getElementById('imageZoomOverlay');
  const zoomedImg = document.getElementById('zoomedImage');

  // Set the source and show overlay
  zoomedImg.src = img.src;
  overlay.classList.add('active');

  // Prevent body scrolling when overlay is open
  document.body.style.overflow = 'hidden';
}

function closeZoom() {
  const overlay = document.getElementById('imageZoomOverlay');
  overlay.classList.remove('active');

  // Restore body scrolling
  document.body.style.overflow = 'auto';
}

// Close zoom on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeZoom();
  }
});
</script>

</body>
</html>